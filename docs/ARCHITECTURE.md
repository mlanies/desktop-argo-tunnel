# Desktop Argo Tunnel Manager - Архитектура

## Обзор

Desktop Argo Tunnel Manager - это десктопное приложение на базе Tauri, которое предоставляет графический интерфейс для управления TCP-туннелями `cloudflared access`. Приложение фокусируется на клиентском управлении туннелями, позволяя пользователям подключаться к удаленным сервисам через защищенную сеть Cloudflare.

## Диаграмма архитектуры

```
┌─────────────────────────────────────────────────────────────┐
│                     Frontend (React)                        │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  Dashboard   │  │   Servers    │  │   Active     │       │
│  │  Панель      │  │  Управление  │  │ Connections  │       │
│  │  управления  │  │  серверами   │  │ Активные     │       │
│  │              │  │              │  │ подключения  │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│                                                             │
│  ┌──────────────────────────────────────────────────┐       │
│  │           Zustand Store (Состояние)              │       │
│  │  - tunnels: ActiveTunnel[]                       │       │
│  │  - servers: Server[]                             │       │
│  │  - recentConnections: RecentConnection[]         │       │
│  └──────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────┘
                            ↕ IPC (Tauri Commands)
┌─────────────────────────────────────────────────────────────┐
│                    Backend (Rust/Tauri)                     │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────┐       │
│  │         Cloudflared Commands Module              │       │
│  │  - start_tcp_tunnel(hostname, port)              │       │
│  │  - stop_tcp_tunnel(id)                           │       │
│  │  - check_cloudflared_version()                   │       │
│  └──────────────────────────────────────────────────┘       │
│                                                             │
│  ┌──────────────────────────────────────────────────┐       │
│  │    TunnelState (Менеджер процессов)              │       │
│  │  - processes: HashMap<String, u32>               │       │
│  │    (tunnel_id -> PID)                            │       │
│  └──────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────┘
                            ↕ Запуск процесса
┌─────────────────────────────────────────────────────────────┐
│                 Cloudflared Binary                          │
│  cloudflared access tcp --hostname <host> --url <local>     │
└─────────────────────────────────────────────────────────────┘
```

## Основные компоненты

### Frontend (React + TypeScript)

#### 1. **Dashboard (Панель управления)**
- **Назначение**: Обзор состояния системы и недавней активности
- **Функции**:
  - Количество активных туннелей
  - История недавних подключений
  - Быстрый доступ к избранному
  - Визуализация статистики

#### 2. **Server Management (Управление серверами)**
- **Назначение**: Управление удаленными серверами и сервисами
- **Функции**:
  - Иерархический вид (Компания → Сервер → Сервис)
  - Протоколы сервисов: SSH, RDP, TCP
  - Подключение в один клик
  - Управление избранным
  - Отслеживание статуса подключения

**Процесс подключения**:
```
Пользователь нажимает "Connect" 
  → Генерация случайного порта (10000-60000)
  → Вызов startTcpTunnel(hostname, port)
  → Backend запускает процесс cloudflared
  → Сохранение туннеля в состоянии
  → Отображение локального порта пользователю
```

#### 3. **Active Connections (Активные подключения)**
- **Назначение**: Мониторинг и управление запущенными TCP-туннелями
- **Функции**:
  - Список всех активных туннелей
  - Отображение: hostname, локальный порт, PID, время работы
  - Остановка туннеля
  - Копирование локального порта в буфер обмена

#### 4. **Settings (Настройки)**
- **Назначение**: Конфигурация приложения
- **Функции**:
  - Выбор языка (EN/RU)
  - Выбор темы (Темная/Светлая/Системная)
  - Путь к бинарнику cloudflared
  - Настройки автоподключения

### Backend (Rust + Tauri)

#### 1. **Модуль команд Cloudflared**
Расположение: `src-tauri/src/cloudflared/commands.rs`

**Функции**:
- `check_cloudflared_version()` - Проверка установки cloudflared
- `start_tcp_tunnel(hostname, port)` - Запуск TCP-туннеля
- `stop_tcp_tunnel(id)` - Остановка туннеля

**Структура ActiveTunnel**:
- `id` - Идентификатор (формат: "{hostname}-{port}")
- `hostname` - Удаленный хост
- `local_port` - Локальный порт прослушивания
- `pid` - ID процесса

#### 2. **TunnelState (Менеджер процессов)**
Расположение: `src-tauri/src/cloudflared/commands.rs`

**Назначение**: Отслеживание активных процессов cloudflared

**Структура**: HashMap, где ключ - tunnel_id, значение - PID процесса

**Жизненный цикл**:
1. `start_tcp_tunnel`: Запуск процесса → Сохранение PID
2. `stop_tcp_tunnel`: Поиск PID → Завершение процесса → Удаление из map

### Управление состоянием (Zustand)

Расположение: `src/store.ts`

**Структура состояния**:
- `tunnels` - Активные TCP-туннели
- `services_by_server_by_company` - Иерархия серверов
- `activeTab` - Текущая вкладка UI
- `selectedServerId` / `selectedServiceId` - Выбранные элементы
- `recentConnections` - Недавние подключения
- `favorites` - Избранное
- `settings` - Настройки пользователя

**Действия**:
- Управление туннелями: `startTcpTunnel`, `stopTcpTunnel`
- Управление серверами: `handleConnectService`, `handleDisconnectService`
- UI состояние: `setActiveTab`, `toggleFavorite`

## Поток данных

### Установка подключения

```
1. Пользовательский интерфейс
   └─> ServerManagement.tsx
       └─> handleToggleConnection()
           └─> Генерация случайного порта
           
2. Действие Store
   └─> startTcpTunnel(hostname, localPort)
       └─> invoke('start_tcp_tunnel', { hostname, localPort })
       
3. Rust Backend
   └─> start_tcp_tunnel()
       └─> Запуск cloudflared через Command::spawn()
       └─> Сохранение PID в TunnelState
       └─> Возврат ActiveTunnel
       
4. Обновление Frontend
   └─> Добавление туннеля в state.tunnels[]
   └─> Обновление UI (показ локального порта)
```

### Завершение подключения

```
1. Пользовательский интерфейс
   └─> ActiveConnections.tsx или ServerManagement.tsx
       └─> handleStopTunnel(id)
       
2. Действие Store
   └─> stopTcpTunnel(id)
       └─> invoke('stop_tcp_tunnel', { id })
       
3. Rust Backend
   └─> stop_tcp_tunnel()
       └─> Поиск PID в TunnelState
       └─> Завершение процесса (зависит от платформы)
           - Unix: kill <pid>
           - Windows: taskkill /F /PID <pid>
       └─> Удаление из TunnelState
       
4. Обновление Frontend
   └─> Удаление туннеля из state.tunnels[]
   └─> Обновление UI
```

## Структура файлов

```
desktop-argo-tunnel/
├── src/                           # Frontend
│   ├── components/
│   │   ├── Dashboard/
│   │   │   └── Dashboard.tsx      # Главная панель
│   │   ├── Servers/
│   │   │   └── ServerManagement.tsx  # Управление серверами
│   │   ├── Tunnels/
│   │   │   └── ActiveConnections.tsx # Список активных туннелей
│   │   ├── Settings/
│   │   │   └── Settings.tsx       # Настройки приложения
│   │   ├── Navigation/
│   │   │   ├── Sidebar.tsx        # Главная навигация
│   │   │   └── NavItem.tsx
│   │   └── CommandPalette/
│   │       └── CommandPalette.tsx # Поиск Cmd+K
│   ├── routes/
│   │   ├── __root.tsx             # Корневой layout
│   │   └── index.tsx              # Главный маршрут
│   ├── i18n/
│   │   └── locales/
│   │       ├── en.json            # Английские переводы
│   │       └── ru.json            # Русские переводы
│   ├── store.ts                   # Управление состоянием Zustand
│   └── main.tsx                   # Точка входа
│
├── src-tauri/                     # Backend
│   ├── src/
│   │   ├── cloudflared/
│   │   │   ├── mod.rs             # Определение модуля
│   │   │   └── commands.rs        # Tauri команды
│   │   ├── lib.rs                 # Главная библиотека
│   │   └── main.rs                # Точка входа
│   ├── Cargo.toml                 # Зависимости Rust
│   └── tauri.conf.json            # Конфигурация Tauri
│
└── docs/
    ├── ARCHITECTURE.md            # Этот файл
    └── screenshots/               # Скриншоты UI
```

## Ключевые технологии

### Frontend
- **React 18** - UI фреймворк
- **TypeScript** - Типобезопасность
- **Zustand** - Управление состоянием
- **TanStack Router** - Роутинг
- **i18next** - Интернационализация
- **Tailwind CSS** - Стилизация
- **Lucide React** - Иконки

### Backend
- **Rust** - Системный язык программирования
- **Tauri 2.0** - Десктопный фреймворк
- **Serde** - Сериализация
- **Tokio** - Async runtime (неявно через Tauri)

### Внешние зависимости
- **cloudflared** - Бинарник Cloudflare tunnel
- **OS Process Management** - Нативное управление процессами

## Безопасность

1. **Изоляция процессов**: Каждый туннель работает как отдельный процесс `cloudflared`
2. **Локальное хранилище**: Все данные хранятся локально, без облачной синхронизации
3. **Хранение учетных данных**: Использует нативное безопасное хранилище ОС (keychain)
4. **Безопасность IPC**: Защищенный IPC слой Tauri между frontend и backend
5. **Без повышенных привилегий**: Приложение работает с правами пользователя

## Ограничения и планы развития

### Текущие ограничения
1. **Нет персистентности процессов**: Активные туннели теряются при перезапуске приложения
2. **Только случайный порт**: Нельзя указать кастомный локальный порт
3. **Нет стриминга логов**: Нельзя просматривать логи cloudflared в реальном времени
4. **Нет конфигурации туннелей**: Нельзя настраивать ingress правила

### Планируемые улучшения
1. **Восстановление процессов**: Обнаружение и переподключение к существующим процессам cloudflared
2. **Выбор кастомного порта**: Возможность указать локальный порт вручную
3. **Просмотр логов**: Стриминг и отображение вывода cloudflared
4. **Редактор конфигурации**: Управление файлами конфигурации туннелей
5. **Авто-переподключение**: Перезапуск туннелей при сбое
6. **Метрики туннелей**: Пропускная способность, задержка, количество подключений

## Характеристики производительности

- **Время запуска**: ~1-2 секунды (overhead Tauri)
- **Использование памяти**: ~50-100 МБ (базовое приложение + активные туннели)
- **Overhead процесса**: ~10-20 МБ на активный туннель (процесс cloudflared)
- **Диапазон портов**: 10000-60000 (50,000 возможных портов)
- **Макс. одновременных туннелей**: Ограничено доступными портами и ресурсами системы
